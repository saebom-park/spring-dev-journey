package com.review52.service;

import com.review52.repository.MemberRepository;
import com.review52.repository.ProductRepository;
import com.review52.repository.OrderRepository;
import com.review52.repository.OrderItemRepository;
import com.review52.dto.OrderItemDto;
import com.review52.dto.OrderRequestDto;
import com.review52.dto.OrderResponseDto;
import com.review52.domain.Member;
import com.review52.domain.Product;
import com.review52.domain.Order;
import com.review52.domain.OrderItem;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.util.Optional;
import java.util.List;
import java.util.ArrayList;

@Service
public class OrderServiceImpl implements OrderService {
    private final MemberRepository memberRepository;
    private final ProductRepository productRepository;
    private final OrderRepository orderRepository;
    private final OrderItemRepository orderItemRepository;

    // constructor
    public OrderServiceImpl(MemberRepository memberRepository, ProductRepository productRepository, OrderRepository orderRepository, OrderItemRepository orderItemRepository) {
        this.memberRepository = memberRepository;
        this.productRepository = productRepository;
        this.orderRepository = orderRepository;
        this.orderItemRepository = orderItemRepository;
    }

    @Override
    @Transactional
    public OrderResponseDto createOrder(OrderRequestDto requestDto) {
        // 1. ê¸°ë³¸ ê²€ì¦
        if (requestDto.getItems() == null || requestDto.getItems().isEmpty()) {
            throw new IllegalArgumentException("ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        // 2. íšŒì› ì¡°íšŒ
        Optional<Member> optionalMember = memberRepository.findById(requestDto.getMemberId());
        Member member = optionalMember.orElseThrow(() -> new IllegalArgumentException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íšŒì›ì…ë‹ˆë‹¤. ID: " + requestDto.getMemberId()));

        // 3. ì£¼ë¬¸ ìƒí’ˆë“¤ ìƒì„± ë° ê²€ì¦
        List<OrderItem> items = new ArrayList<>();
        for (OrderItemDto item : requestDto.getItems()) {
            // ìˆ˜ëŸ‰ ê²€ì¦
            if (item.getQuantity() <= 0) {
                throw new IllegalArgumentException("ì£¼ë¬¸ ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤. ìƒí’ˆ ID: " + item.getProductId());
            }

            // ê°€ê²© ê²€ì¦
            if (item.getOrderPrice() < 0) {
                throw new IllegalArgumentException("ì£¼ë¬¸ ê°€ê²©ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤. ìƒí’ˆ ID: " + item.getProductId());
            }

            // ìƒí’ˆ ì¡°íšŒ
            Optional<Product> optionalProduct = productRepository.findById(item.getProductId());
            Product product = optionalProduct.orElseThrow(() -> new IllegalArgumentException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤. ID: " + item.getProductId()));

            // ìƒí’ˆ ê°€ê²©ê³¼ ì£¼ë¬¸ ê°€ê²© ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
            if (product.getPrice() != item.getOrderPrice()) {
                throw new IllegalArgumentException("ìƒí’ˆ ê°€ê²©ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒí’ˆ ID: " + item.getProductId() +
                    ", ìƒí’ˆ ê°€ê²©: " + product.getPrice() + ", ì£¼ë¬¸ ê°€ê²©: " + item.getOrderPrice());
            }

            OrderItem orderItem = new OrderItem(item.getQuantity(), item.getOrderPrice(), product);
            items.add(orderItem);
        }

        // 4. ì£¼ë¬¸ ìƒì„±
        Order order = new Order();

        // ğŸ”´ ì¤‘ìš”! Memberì™€ Order ì—°ê´€ê´€ê³„ ì„¤ì •
        order.setMember(member);

        // 5. ì£¼ë¬¸ ì•„ì´í…œë“¤ì„ ì£¼ë¬¸ì— ì¶”ê°€
        for (OrderItem item : items) {
            order.addOrderItem(item);
        }

        // 6. ì£¼ë¬¸ ì €ì¥
        Order savedOrder = orderRepository.save(order);

        return new OrderResponseDto(savedOrder.getId(), member.getName(), savedOrder.getOrderDate(), savedOrder.getStatus(), requestDto.getItems());
    }

    @Override
    @Transactional(readOnly=true)
    public List<OrderResponseDto> getOrders() {
        List<OrderResponseDto> result = new ArrayList<>();
        List<Order> orders = orderRepository.findAll();

        for (Order order : orders) {
            // ì£¼ë¬¸ ë³„ ìƒí’ˆë“¤ì„ DTOë¡œ ë³€í™˜
            List<OrderItemDto> itemDtos = new ArrayList<>();
            for (OrderItem orderItem : order.getOrderItems()) {
                OrderItemDto itemDto = new OrderItemDto(
                    orderItem.getProduct().getId(),
                    orderItem.getQuantity(),
                    orderItem.getOrderPrice()
                );
                itemDtos.add(itemDto);
            }

            // ì‘ë‹µ DTO ìƒì„±
            OrderResponseDto responseDto = new OrderResponseDto(
                order.getId(),
                order.getMember().getName(),
                order.getOrderDate(),
                order.getStatus(),
                itemDtos
            );
            result.add(responseDto);
        }
        return result;
    }
}