# [DEPLOY-2ë‹¨ê³„] Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • (nginx-setup)

> EC2ì—ì„œ 8080(Sprint Boot)ìœ¼ë¡œ ë–  ìˆëŠ” ë°±ì—”ë“œ ì•ë‹¨ì— Nginxë¥¼ ì„¸ì›Œ
> 
> 
> í´ë¼ì´ì–¸íŠ¸ëŠ” `http://<EC2_IP>`(80)ë¡œë§Œ ì ‘ì†í•˜ê²Œ ë§Œë“¤ê³ ,
> 
> ë‚´ë¶€ì—ì„  `localhost:8080`ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ **ì¤‘ê³„(Reverse Proxy)** í•˜ëŠ” ë‹¨ê³„.
> 
> ë‹¤ìŒ ë‹¨ê³„(DEPLOY-3)ì—ì„œ HTTPS(443)ë¡œ í™•ì¥í•  ì¤€ë¹„ë¥¼ ë§ˆì¹œë‹¤.
> 

---

## ğŸ’¡ í•µì‹¬ ê°œë… ìš”ì•½ (ì›ë¦¬ ì¤‘ì‹¬)

| í•­ëª© | ê°œë…/ì›ë¦¬ | ì™œ í•„ìš”í•œê°€(íš¨ê³¼) | ì‹¤ë¬´ í¬ì¸íŠ¸ |
| --- | --- | --- | --- |
| **Reverse Proxy** | í´ë¼ì´ì–¸íŠ¸â†’Nginxâ†’SpringBootì˜ **ëŒ€ë¦¬ ìš”ì²­** êµ¬ì¡° | 8080 ê°™ì€ ë‚´ë¶€ í¬íŠ¸ë¥¼ ì™¸ë¶€ì— ìˆ¨ê¹€(ë³´ì•ˆ), í¬íŠ¸ í‘œì¤€í™”(80/443), ì¶”í›„ HTTPS ì‰½ê²Œ ì ìš© | â€œì•ë‹¨ ë¬¸ì§€ê¸°â€ê°€ Nginx, â€œì‹¤ì œ ì¼ê¾¼â€ì´ Spring |
| **listen 80** | Nginxê°€ 80ë²ˆ í¬íŠ¸ì—ì„œ HTTP ìˆ˜ì‹  | ì‚¬ìš©ì URLì„ ë‹¨ìˆœí™”(`:8080` ë¶ˆí•„ìš”) | 80/443ì€ **í‘œì¤€ í¬íŠ¸**, ë¸Œë¼ìš°ì €/í”„ë¡ì‹œê°€ ê¸°ë³¸ ê¸°ëŒ€ |
| **proxy_pass** | Nginxê°€ ë°›ì€ ìš”ì²­ì„ **ë°±ì—”ë“œë¡œ ì „ë‹¬** | ë°±ì—”ë“œ ìœ„ì¹˜ ì€ë‹‰, ê²½ë¡œ/í—¤ë” ì œì–´ | `http://localhost:8080` (ë™ì¼ ë¨¸ì‹ ì´ë©´ localhostê°€ ê°€ì¥ ì•ˆì „/ë¹ ë¦„) |
| **í—¤ë” ì „ë‹¬** | `X-Real-IP`, `X-Forwarded-For`, `X-Forwarded-Proto` | ì›ê²© IP/ìŠ¤í‚´(HTTP/HTTPS) ë³´ì¡´ â†’ ë¡œê¹…/ë³´ì•ˆ/ë¦¬ë‹¤ì´ë ‰íŠ¸ ì •í™•ì„± | Spring Security, ë¡œê¹…(IP ì°¨ë‹¨)ì—ì„œ í•„ìˆ˜ |
| **sites-available / enabled** | **ì„¤ì • ë²„ì „ ê´€ë¦¬** ë””ë ‰í„°ë¦¬ ë¶„ë¦¬ | êµ¬ì„± ì „í™˜/ë¡¤ë°± ì‰¬ì›€ | ìƒˆ confëŠ” `sites-available`ì— ë§Œë“¤ê³ , ë§í¬ë¡œ í™œì„±í™” |
| **ê¸°ë³¸ ì„œë²„ ì œê±°** | `/etc/nginx/sites-enabled/default` | ì¶©ëŒ/ì˜ˆìƒì¹˜ ëª»í•œ ë¼ìš°íŒ… ë°©ì§€ | ìƒˆ confë§Œ í™œì„±í™”í•´ ë¼ìš°íŒ…ì„ â€œëª…ì‹œì â€ìœ¼ë¡œ ìš´ì˜ |
| **nginx -t** | ì„¤ì • ë¬¸ë²• ê²€ì¦ | ì˜¤íƒ€/ì˜¤ì„¤ì • ë¹ ë¥´ê²Œ ì°¨ë‹¨ | ì¬ì‹œì‘ ì „ì— ë°˜ë“œì‹œ ê²€ì‚¬(ì‹¤ë¬´ ìŠµê´€) |
| **ë³´ì•ˆ ê·¸ë£¹/ufw** | 80/443 ì—´ê¸°(EC2), ë‚´ë¶€ ë°©í™”ë²½ í—ˆìš©(ufw) | ì™¸ë¶€ê°€ 80ìœ¼ë¡œ ì ‘ì† ê°€ëŠ¥í•´ì•¼ í•¨ | 8080ì€ ë‚´ë¶€ í™•ì¸ìš©. ë³¸ ì„œë¹„ìŠ¤ëŠ” 80/443ì—ì„œë§Œ ë…¸ì¶œ |
| **ë¡œê·¸** | `/var/log/nginx/access.log`, `error.log` | ë¦¬í€˜ìŠ¤íŠ¸ í˜„í™©/ì˜¤ë¥˜ ì›ì¸ ì¶”ì  | 502/504 ì‹œ ìš°ì„  error.log í™•ì¸ â†’ |

> ì§ê´€ ë¹„ìœ :
> 
> 
> ì‚¬ìš©ìëŠ” ê±´ë¬¼ ë¡œë¹„(Nginx)ì—ì„œë§Œ ì¶œì…í•˜ê³ , ì‹¤ì œ ì‚¬ë¬´ì‹¤(Spring)ì€ **ë‚´ë¶€ í†µë¡œ(8080)** ë¡œë§Œ ì—°ê²°ë¼ ìˆì–´ìš”.
> 
> ë¡œë¹„ì—ì„œ ë°©ë¬¸ê¸°ë¡(ë¡œê·¸)ë„ ë‚¨ê¸°ê³ , ì¶œì… ê·œì¹™(HTTPS/ë¦¬ë‹¤ì´ë ‰íŠ¸)ë„ í†µì œí•˜ì£ .
> 

---

## ğŸ§¾ ì˜ˆì‹œ ì½”ë“œ / ì„¤ì • (ì´í•´â†’ì‹¤ìŠµ ìˆœì„œ)

### 0) ì„ í–‰ ì¡°ê±´ í™•ì¸

- EC2(Ubuntu 22.04) ì‹¤í–‰ ì¤‘, SSH ì ‘ì† ê°€ëŠ¥ âœ…
- Spring ì•±ì´ **systemd**ë¡œ ë“±ë¡ë˜ì–´ 8080ì—ì„œ ë™ì‘ ê°€ëŠ¥ âœ…
    
    ```bash
    sudo systemctl status springlab23 --no-pager
    # active (running) ë˜ëŠ” start ê°€ëŠ¥ ìƒíƒœ
    
    ```
    

---

### 1) Nginx ì„¤ì¹˜ & ì„œë¹„ìŠ¤ ìƒíƒœ

```bash
sudo apt update
sudo apt install -y nginx
sudo systemctl status nginx --no-pager

```

- `active (running)` ì´ë©´ ì •ìƒ.
- ë¸Œë¼ìš°ì €ì—ì„œ `http://<EC2_IP>` ì ‘ì† ì‹œ â€œWelcome to nginx!â€ ê¸°ë³¸ í˜ì´ì§€ê°€ ë³´ì¼ ìˆ˜ ìˆìŒ
    
    (ê³§ ìš°ë¦¬ ì„¤ì •ìœ¼ë¡œ êµì²´í•  ì˜ˆì •)
    

---

### 2) í”„ë¡ì‹œ ì„¤ì • íŒŒì¼ ì‘ì„± (í•µì‹¬: ì™œ ì´ë ‡ê²Œ ì“°ëŠ”ì§€ í•¨ê»˜ í‘œê¸°)

```bash
sudo vi /etc/nginx/sites-available/springlab.conf

```

**ë‚´ìš©:**

```
# 1) ì„œë²„ ë¸”ë¡: 80 í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  HTTP ìš”ì²­ ìˆ˜ì‹ 
server {
    listen 80;
    server_name _;  # ì™¸ë¶€ ë„ë©”ì¸ ì—†ì„ ë•ŒëŠ” ì™€ì¼ë“œì¹´ë“œ. ì´í›„ ë„ë©”ì¸ ì—°ê²° ì‹œ êµì²´.

    # 2) ë£¨íŠ¸ ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì€ ë‚´ë¶€ Spring Bootë¡œ í”„ë¡ì‹œ
    location / {
        proxy_pass http://localhost:8080;  # ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ë©´ localhostê°€ ê°€ì¥ ì•ˆì „/ë¹ ë¦„

        # 3) ì›ë³¸ ìš”ì²­ ì •ë³´ ë³´ì¡´ (ì‹¤ë¬´ í•„ìˆ˜: ë¡œê¹…Â·ë³´ì•ˆÂ·ë¦¬ë‹¤ì´ë ‰íŠ¸ ì •í™•ì„±)
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 4) ì•ˆì •ì„±(ì˜µì…˜): ë°±ì—”ë“œ íƒ€ì„ì•„ì›ƒ/ë²„í¼ ì„¤ì •(ê¸°ë³¸ê°’ìœ¼ë¡œë„ ì¶©ë¶„)
        proxy_read_timeout 60s;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        # í° ì‘ë‹µ(ì˜ˆ: ëŒ€í˜• JSON) ì²˜ë¦¬ ì—¬ìœ 
        proxy_buffering on;
    }

    # (ì„ íƒ) í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë”°ë¡œ ë‘˜ ìˆ˜ë„ ìˆìŒ
    # location /healthz { return 200 "ok\n"; add_header Content-Type text/plain; }
}

```

**ì™œ ì´ë ‡ê²Œ?**

- `server_name _;` : ë„ë©”ì¸ì´ ì—†ì„ ë•Œ ëª¨ë“  í˜¸ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬. ë‚˜ì¤‘ì— HTTPS/ë„ë©”ì¸ ë¶™ì´ë©´ `example.com`ìœ¼ë¡œ êµì²´.
- `proxy_set_header` 4ì¢…:
    - **Host**: ê°€ë” ì•±/í”„ë ˆì„ì›Œí¬ê°€ ì›ë³¸ í˜¸ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸/ë§í¬ ìƒì„±
    - **X-Real-IP**, **X-Forwarded-For**: ì‹¤ì‚¬ìš©ì IP ë³´ì¡´(ë³´ì•ˆÂ·ê°ì‚¬Â·ìš”ê¸ˆ ì œí•œì— ì¤‘ìš”)
    - **X-Forwarded-Proto**: ë‚˜ì¤‘ì— HTTPSì¼ ë•Œë„ ì•±ì´ ì˜¬ë°”ë¥¸ ìŠ¤í‚´(https)ì„ ì¸ì§€

---

### 3) í™œì„±í™”(ì‹¬ë³¼ë¦­ ë§í¬) & ê¸°ë³¸ ì„¤ì • ì œê±°

```bash
# í™œì„±í™”
sudo ln -s /etc/nginx/sites-available/springlab.conf /etc/nginx/sites-enabled/springlab.conf

# (ê¶Œì¥) ê¸°ë³¸ ì„œë²„ ë¹„í™œì„±í™”: ë¼ìš°íŒ… ì¶©ëŒ ë°©ì§€
sudo rm -f /etc/nginx/sites-enabled/default

```

> âš ï¸ â€œê¸°ë³¸ confë¥¼ ë†”ë‘ë©´?â€
> 
> 
> path ë§¤ì¹­/ìš°ì„ ìˆœìœ„ ë•Œë¬¸ì— ìš”ì²­ì´ ê¸°ë³¸ ì„œë²„ë¡œ í˜ëŸ¬ê°ˆ ìˆ˜ ìˆì–´ìš”.
> 
> **ëª…ì‹œì ì¸ ë‹¨ì¼ conf**ë¡œ ìš´ì˜í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.
> 

---

### 4) ë¬¸ë²• ê²€ì‚¬ â†’ ì¬ì‹œì‘ (ì‹¤ë¬´ ìŠµê´€)

```bash
sudo nginx -t
# â†’ syntax is ok / test is successful
sudo systemctl restart nginx

```

> âš ï¸ nginx -t ê°€ ì‹¤íŒ¨í•˜ë©´ ì¬ì‹œì‘ í•˜ì§€ ë§ê³  ì—ëŸ¬ ë©”ì‹œì§€ ë¼ì¸ ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ìˆ˜ì •.
> 

---

### 5) ë³´ì•ˆ ê·¸ë£¹/ë°©í™”ë²½ í™•ì¸

- **AWS ë³´ì•ˆ ê·¸ë£¹**(EC2 ì½˜ì†”)
    - ì¸ë°”ìš´ë“œ: `HTTP 80` **í—ˆìš©**, `HTTPS 443` **ë¯¸ë¦¬ í—ˆìš©**(ë‹¤ìŒ ë‹¨ê³„), `SSH 22` ìœ ì§€
- **(ì„ íƒ) UFW ì‚¬ìš© ì‹œ**
    
    ```bash
    sudo ufw allow 80/tcp
    sudo ufw allow 443/tcp    # ë‹¤ìŒ ë‹¨ê³„(HTTPS) ëŒ€ë¹„
    sudo ufw status
    
    ```
    

> ê¶Œì¥ ìš´ì˜: ì™¸ë¶€ì—ëŠ” 80/443ë§Œ ì—´ê³ , 8080ì€ ë‹«ê¸°(ë‚´ë¶€ í™•ì¸ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
> 

---

### 6) ë™ì‘ í…ŒìŠ¤íŠ¸ (ì •ìƒ íë¦„ê³¼ ì‹¤íŒ¨ ì‹œ ë¶„ê¸°)

```bash
# ì„œë²„ ë‚´ë¶€ì—ì„œ ë¨¼ì €
curl -i http://localhost
# ê¸°ëŒ€: Nginx â†’ SpringBootë¡œ í”„ë¡ì‹œë˜ì–´ 200 OK + ì•± ì‘ë‹µ

# ë¡œì»¬ ë¸Œë¼ìš°ì €
http://<EC2_IP>

```

- **ì •ìƒ**: Springì˜ `/hello` ë“± ì—”ë“œí¬ì¸íŠ¸ê°€ ê·¸ëŒ€ë¡œ ì‘ë‹µ
- **502 Bad Gateway**:
    - Springì´ êº¼ì ¸ ìˆê±°ë‚˜(8080 ë¯¸ë™ì‘)
        
        â†’ `sudo systemctl status springlab23` í™•ì¸ í›„ `start`
        
    - `proxy_pass` ì£¼ì†Œ ì˜¤íƒ€
        
        â†’ conf ì¬í™•ì¸ í›„ `nginx -t` â†’ `restart`
        
- **403/404**:
    - ë¼ìš°íŒ…/ì»¨íŠ¸ë¡¤ëŸ¬ ê²½ë¡œ í™•ì¸
    - ê¸°ì¡´ ê¸°ë³¸ conf ì”ì¡´ ì—¬ë¶€ í™•ì¸(`/etc/nginx/sites-enabled`)

**ë¡œê·¸ë¡œ ë¹ ë¥´ê²Œ íŒë‹¨í•˜ê¸°**

```bash
# Nginx
sudo tail -n 100 /var/log/nginx/error.log
sudo tail -n 100 /var/log/nginx/access.log

# Spring(systemd)
sudo journalctl -u springlab23 -n 100 --no-pager

```

---

### 7) (ì˜µì…˜) ì •ì  íŒŒì¼/í—¬ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ ë¶„ë¦¬ ì˜ˆì‹œ

```
server {
    listen 80;
    server_name _;

    # ì •ì : Nginxê°€ ë°”ë¡œ ì„œë¹™ â†’ ë°±ì—”ë“œ ë¶€í•˜ ê°ì†Œ
    location /assets/ {
        alias /var/www/assets/;   # ì˜ˆ: ë°°í¬ëœ ì •ì  í´ë”
        access_log off;
        expires 7d;
    }

    # í—¬ìŠ¤ì²´í¬: ë¡œë“œë°¸ëŸ°ì„œ/ëª¨ë‹ˆí„°ë§ìš©
    location = /healthz {
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    # ë‚˜ë¨¸ì§€ëŠ” ë°±ì—”ë“œë¡œ
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

```

> ì‹¤ë¬´ íŒ: ì •ì ì€ Nginx, ë™ì ì€ Springë¡œ ë¶„ë¦¬í•˜ë©´ íŠ¸ë˜í”½ì´ ì»¤ì§ˆ ë•Œ ë¹„ìš©/ì„±ëŠ¥ì´ í™•ì‹¤íˆ ì¢‹ì•„ì§‘ë‹ˆë‹¤.
> 

---

## ğŸ“Œ í¬ì¸íŠ¸ ìš”ì•½ (í•œ ì¥ ì •ë¦¬)

- **Nginx = ì•ë‹¨ ë¬¸ì§€ê¸°**, Spring = ë‚´ë¶€ ì‘ì—…ì
    
    â†’ 80/443ë§Œ ì™¸ë¶€ ë…¸ì¶œ, 8080ì€ ë‚´ë¶€ ì „ìš©
    
- ì„¤ì •ì€ **`sites-available`ì— ì‘ì„± â†’ ë§í¬ë¡œ í™œì„±í™”**
    
    â†’ ë¡¤ë°±/ì—¬ëŸ¬ ë²„ì „ ìš´ì˜ì´ ì‰¬ì›€
    
- **í—¤ë” 4ì¢…**(Host/Real-IP/Forwarded-For/Proto)ì€ **í•„ìˆ˜ ê´€ë¡€**
    
    â†’ ì¶”í›„ HTTPS/ë³´ì•ˆ/ë¡œê¹… ì •í™•ë„ì— ì§ì ‘ ì˜í–¥
    
- ë³€ê²½ ì‹œ **`nginx -t` â†’ `systemctl restart nginx`** ìˆœì„œ ê³ ì •
- ì¥ì•  ì¶”ì ì€ **Nginx error.log â†’ access.log â†’ Spring journalctl** ìˆœìœ¼ë¡œ
- ë‹¤ìŒ ë‹¨ê³„(DEPLOY-3)ì—ì„œ **Certbot(HTTPS) + 80â†’443 ë¦¬ë‹¤ì´ë ‰íŠ¸**ë¥¼ ì–¹ëŠ”ë‹¤

---

## ğŸ§ª ì‹¤ìŠµ ë¯¸ì…˜ (ì²´ë“ ë£¨í‹´)

ğŸ¯ **ëª©í‘œ:**

Nginx ì„¤ì¹˜â†’í”„ë¡ì‹œ ì„¤ì •â†’í…ŒìŠ¤íŠ¸â†’ë¡œê·¸ í™•ì¸ê¹Œì§€ **í•œ ë²ˆì— ì„±ê³µ**í•˜ê³ ,

ë¬¸ì œê°€ ë‚  ë•Œ **ì–´ë–¤ ë¡œê·¸ë¶€í„° ë³¼ì§€** ë£¨í‹´ìœ¼ë¡œ ëª¸ì— ìµíŒë‹¤.

1. **ì„¤ì¹˜/ìƒíƒœ í™•ì¸**: `sudo apt install -y nginx` â†’ `systemctl status nginx`
2. **conf ì‘ì„±**: `/etc/nginx/sites-available/springlab.conf` ìƒì„±(ë³¸ë¬¸ ì˜ˆì‹œ ê·¸ëŒ€ë¡œ)
3. **í™œì„±í™”/ì •ë¦¬**: `ln -s â€¦/available/â€¦ /â€¦/enabled/â€¦` â†’ `rm -f default`
4. **ê²€ì‚¬/ì¬ì‹œì‘**: `sudo nginx -t` â†’ `sudo systemctl restart nginx`
5. **ë³´ì•ˆê·¸ë£¹/ufw**: 80(í•„ìˆ˜), 443(ì˜ˆê³ ) í—ˆìš©. 8080ì€ **ì™¸ë¶€ ì°¨ë‹¨** ê¶Œì¥
6. **ë™ì‘ í™•ì¸**: `curl http://localhost` â†’ ë¸Œë¼ìš°ì € `http://<EC2_IP>`
7. **ì¥ì•  ì‹œ ë¡œê·¸ ë£¨í‹´**:
    - â‘  `sudo tail -n 100 /var/log/nginx/error.log`
    - â‘¡ `sudo journalctl -u springlab23 -n 100 --no-pager`
    - â‘¢ conf ìˆ˜ì • â†’ `nginx -t` â†’ ì¬ì‹œì‘
8. **ì •ë¦¬ ë©”ëª¨**: â€œë‚´ ì„œë²„ì˜ ìš”ì²­ì€ 80 â†’ Nginx â†’ localhost:8080 â†’ Springâ€ íë¦„ìœ¼ë¡œ ê·¸ë ¤ë³´ê¸°

> ì°¸ê³ : 502ë©´ â€œë°±ì—”ë“œê°€ ì£½ì—ˆê±°ë‚˜ ì£¼ì†Œê°€ í‹€ë¦¼â€, 404ë©´ â€œê²½ë¡œ/ë¼ìš°íŒ…â€, 403ì€ â€œê¶Œí•œ/í¼ë¯¸ì…˜/ë””ë ‰í† ë¦¬ ì ‘ê·¼â€ ë¬¸ì œì¼ ë•Œê°€ ë§ì•„.
>